#!/bin/bash

if [ ! -e "/home/letsencrypt/.acme.sh" ]; then
    cd /home/letsencrypt/acme.sh

    ./acme.sh \
        --install \
        --nocron \
        --home /home/letsencrypt/.acme.sh \
        --config-home /home/letsencrypt/acme-config \
        --accountemail "$ACCOUNT_EMAIL"
fi

while true; do
    oc observe routes \
        --all-namespaces \
        --output=gotemplate \
        -a '{{ .spec.host }}' \
        -a '{{ with .metadata.annotations }}{{if index . "openshift.catalysts.cc/letsencrypt"}}true{{end}}{{end}}' \
        --no-headers \
        --exit-after=60m \
        -- update_cert

    if [ $? -ne 0 ]; then
        echo "WARN: oc observe failed, sleeping 60s"
        sleep 60
    fi
done
